本ドキュメントでは、アラート通知メディアでの HTTP 設定の使用方法について説明します。カスタムリクエスト URL、ヘッダー、パラメータ、ボディを通じて、DingTalk やその他のカスタム通知チャネルにアラートメッセージを送信する方法を紹介します。また、これらの設定項目で `{{$event}}`、`{{$tpl}}`、`{{$params}}`、`{{$sendto}}` などの変数を使用して、異なる通知内容を送信する方法についても説明します。

## 1. 設定の概要

HTTP 通知メディアを設定する際の主な設定項目は以下の通りです：

1. **URL**
2. **リクエストヘッダー（Request Header）**
3. **リクエストパラメータ（Query Parameters / Request Parameters）**
4. **リクエストボディ（Request Body）**

> すべての設定で `{{$event}}`、`{{$tpl}}`、`{{$params}}`、`{{$sendto}}` の4つの変数を使用できます。

変数の説明

1. $tpl
- レンダリング後のテキストテンプレート内容を表し、通常は送信される最終的なメッセージテキストです。ユーザーはメッセージテンプレート管理でテンプレートを作成でき、メッセージテンプレートはまずイベント内容に基づいてこのテキストを生成して $tpl 変数に書き込み、その後 $tpl を参照します。
- `{{$tpl.key}}` 変数を使用する場合、メッセージテンプレートで対応する key 値を設定する必要があります。例えば、DingTalk ボットのメッセージテンプレートでは、`title` と `content` の2つの key 値を設定する必要があり、$tpl で `{{$tpl.title}}` と `{{$tpl.content}}` を使用して参照できます。

2. $params
- カスタムパラメータを表し、`{{$params.access_token}}`、`{{$params.token}}` などの設定項目で使用できます。
- これらのパラメータの値は、通知ルールでユーザーが設定でき、実際の送信時に動的に渡されます。例えば、DingTalk 通知メディアでは、ユーザーが異なる token 値を設定することで、異なる DingTalk グループボットでの送信を実現できます。
- `{{$params.xxx}}` を使用する場合、「変数設定」でパラメータ識別子 `xxx` を追加する必要があり、その後ユーザーは通知ルールで `xxx` の値を入力し、最終的にユーザーが設定した `xxx` の値が URL に置き換えられます。

3. $sendto
- 今回の通知の送信先アドレスまたはリストを表し、電話番号、メールアドレス、IM の個人トークンなどが該当します。
- リクエストボディ、URL、リクエストヘッダーなど任意の位置で使用でき、異なる送信先を区別するために使用されます。
- `{{$sendto}}` を使用する場合、「変数設定」でユーザーの連絡方法を設定する必要があり、最終的にユーザーが設定した連絡方法に基づいて $sendto 変数が実際の連絡方法に置き換えられます。

4. $event
- アラートイベントオブジェクトを表し、イベントの原データを直接参照したり、より柔軟な連結を行いたい場合に適しています。

その他の設定項目：

- リクエストタイムアウト時間、リトライ回数、同時実行数、リトライ間隔など
- 証明書検証のスキップの有無
- プロキシ設定など

アラート通知を実行する際、システムはこれらの設定に基づいて1回または複数回の HTTP 呼び出しを行い、アラート情報を第三者プラットフォームにプッシュします。

## 2. 各設定項目の詳細

### 1. URL

**機能**：対象の通知インターフェースアドレス。動的変数の置換をサポートします。  
**設定例**

```text
https://oapi.dingtalk.com/robot/send?access_token={{$params.access_token}}
```

変数 `$params.access_token` を使用する場合、「変数設定」でパラメータ識別子 `access_token` を追加する必要があり、その後ユーザーは通知ルールで `access_token` の値を入力し、最終的にユーザーが設定した `access_token` の値が URL に置き換えられます。

**説明**

- 異なるプラットフォームや異なるインターフェースのリクエストアドレスをここに記述できます（DingTalk ボット、WeCom ボット、Slack Webhook など）。

### 2. リクエストヘッダー（Request Header）

**機能**：HTTP リクエストヘッダー情報を定義します（認証情報、コンテンツタイプなど）。  
**設定例**

| パラメータ名     | パラメータ値            |
| --------------- | ---------------------- |
| `Content-Type`  | `application/json`     |
| `Authorization` | `Bearer {{$params.token}}` |

**説明**

- 一部のプラットフォームでは、リクエストヘッダーに認証情報や `Content-Type` の指定が必要です。
- カスタムリクエストヘッダーが必要な場合は、さらにフィールドを追加できます。

### 3. リクエストパラメータ（Query Parameters / Request Parameters）

**機能**：URL パラメータを通じて軽量データを渡します。  
**設定例**

| パラメータ名    | パラメータ値         |
| -------------- | ------------------- |
| `access_token` | `your-access-token` |

**説明**

- URL クエリ文字列（`?key=value`）に付加するパラメータをここで設定するか、直接 URL に記述することができます。
- 変数を query param として渡す場合、`{{$params.xxx}}` の形式を使用するか、`{{$event}}`、`{{$tpl}}`、`{{$sendto}}` の一部を組み合わせることができます。

### 4. リクエストボディ（Request Body）

**機能**：構造化された通知内容（JSON 形式のアラート詳細など）を渡します。  
**設定例**

```json
{
  "msgtype": "markdown",
  "markdown": {
    "title": "{{$tpl.title}}",
    "text": "{{$tpl.text}}"
  },
  "at": {
    "atMobiles": ["{{$params.ats}}"],
    "isAtAll": false
  }
}
```

**説明**

- JSON 形式（DingTalk、WeCom ボットでよく見られる）またはフォーム形式（application/x-www-form-urlencoded）で送信します。
- リクエストボディ内で $event、$tpl、$params、$sendto などの変数を直接埋め込んで動的に置換できます。
- $tpl は通常アラートテンプレートがレンダリングされた後のテキスト内容を表し、$sendto は通知対象者（電話番号、WeCom アカウントなど）を表すことができます。

## 3. 例：DingTalk ボットへの送信

以下の例は、アラートメッセージを DingTalk グループボットに送信する設定方法を示しています。DingTalk ボットの access_token と特定の電話番号への @ 情報は、ルール設定を通じて $params 変数に渡され、その後 $params.access_token と $sendto 変数をリクエストボディで参照します。

1. 変数設定   
変数設定でパラメータ識別子 `access_token` と `ats` を追加します

2. URL

```
https://oapi.dingtalk.com/robot/send?access_token={{$params.access_token}}
```

3. リクエストヘッダー（Request Header）

| パラメータ名 | パラメータ値 |
|---------------|--------------------|
| `Content-Type` | `application/json` |

4. リクエストパラメータ
| パラメータ名 | パラメータ値 |
|--------------|---------------------|
| `access_token` | `your-access-token` |

5. リクエストボディ

```json
{
  "msgtype": "markdown",
  "markdown": {
    "title": "{{$tpl.title}}",
    "text": "{{$tpl.text}}"
  },
  "at": {
    "atMobiles": ["{{$params.ats}}"],
    "isAtAll": false
  }
}
```

この例では：

- {{$params.access_token}} は実際の DingTalk グループボットの access_token に置き換えられます。
- {{$params.ats}} は実際の DingTalk グループ内で @ する電話番号に置き換えられます。
- {{$tpl.title}} はレンダリング後に送信される最終的なアラートメッセージのタイトルになります（例：「CPU 使用率がしきい値を超過」）。
- {{$tpl.text}} はレンダリング後に送信される最終的なアラートメッセージのテキストになります（例：「CPU 使用率がしきい値を超過、発生時間：2024-01-01 12:00:00」）。