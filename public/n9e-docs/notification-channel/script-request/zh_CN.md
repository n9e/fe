# è„šæœ¬é€šçŸ¥ é…ç½®æŒ‡å—

## ğŸ“– ä»€ä¹ˆæ˜¯è„šæœ¬é€šçŸ¥ï¼Ÿ

è„šæœ¬é€šçŸ¥æ˜¯å¤œèºå¹³å°æä¾›çš„ä¸€ç§**é«˜åº¦çµæ´»**çš„å‘Šè­¦æ¨é€æ–¹å¼ã€‚ç®€å•æ¥è¯´ï¼Œå½“ç³»ç»Ÿå‡ºç°å‘Šè­¦æ—¶ï¼Œå¤œèºä¼šè‡ªåŠ¨è°ƒç”¨æ‚¨ç¼–å†™çš„è„šæœ¬ç¨‹åºæ¥å‘é€é€šçŸ¥ã€‚

## ğŸš€ æ–°æ‰‹å¿«é€Ÿå¼€å§‹

å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨è„šæœ¬é€šçŸ¥ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

### ç¬¬1æ­¥ï¼šç¡®è®¤æ˜¯å¦éœ€è¦è„šæœ¬é€šçŸ¥
è„šæœ¬é€šçŸ¥é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š
- âœ… å…¬å¸ä½¿ç”¨çš„é€šçŸ¥å·¥å…·ä¸åœ¨å¤œèºå†…ç½®åˆ—è¡¨ä¸­ï¼ˆå¦‚ä¼å¾®ã€é’‰é’‰ç­‰å·²å†…ç½®ï¼‰
- âœ… éœ€è¦å¤æ‚çš„æ•°æ®å¤„ç†æˆ–æ ¼å¼è½¬æ¢
- âœ… éœ€è¦åŒæ—¶å‘é€åˆ°å¤šä¸ªä¸åŒæ¸ é“

### ç¬¬2æ­¥ï¼šå‡†å¤‡æµ‹è¯•ç¯å¢ƒ
1. **å…ˆç”¨ç®€å•è„šæœ¬æµ‹è¯•**ï¼ˆå¤åˆ¶æœ¬æ–‡æ¡£ä¸­çš„"å…¥é—¨ç¤ºä¾‹"ï¼‰
2. **ç¡®è®¤æ•°æ®æµé€š**ï¼ˆæ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦æœ‰å†…å®¹ï¼‰
3. **å†æ”¹ä¸ºå®é™…é€šçŸ¥**ï¼ˆä¿®æ”¹ä¸ºé£ä¹¦/ä¼å¾®/å†…éƒ¨ IM ç­‰çœŸå®é€šçŸ¥ï¼‰

### ç¬¬3æ­¥ï¼šé…ç½®é€šçŸ¥æ¸ é“
1. åœ¨å¤œèºç•Œé¢åˆ›å»º"è„šæœ¬é€šçŸ¥"ç±»å‹çš„é€šçŸ¥æ¸ é“
2. é…ç½®å¿…è¦çš„å˜é‡ï¼ˆå¦‚ `access_token`ï¼‰
3. é€‰æ‹©è„šæœ¬é…ç½®æ–¹å¼ï¼ˆå»ºè®®æ–°æ‰‹é€‰æ‹©"ä½¿ç”¨è„šæœ¬"ç›´æ¥ç¼–å†™ï¼‰

### ç¬¬4æ­¥ï¼šæµ‹è¯•éªŒè¯
1. æ‰‹åŠ¨æµ‹è¯•è„šæœ¬ï¼ˆå‚è€ƒæ–‡æ¡£æœ«å°¾çš„æµ‹è¯•æ–¹æ³•ï¼‰
2. åˆ›å»ºæµ‹è¯•å‘Šè­¦è§„åˆ™å…³è”è¯¥é€šçŸ¥æ¸ é“
3. è§¦å‘å‘Šè­¦éªŒè¯é€šçŸ¥æ˜¯å¦æ­£å¸¸

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šå¼ºçƒˆå»ºè®®å…ˆä½¿ç”¨å…¥é—¨ç¤ºä¾‹ä¸­çš„æ—¥å¿—è®°å½•è„šæœ¬è¿›è¡Œæµ‹è¯•ï¼Œç¡®è®¤æ•°æ®ä¼ é€’æ­£å¸¸åï¼Œå†ä¿®æ”¹ä¸ºå®é™…çš„é€šçŸ¥é€»è¾‘ã€‚

## ğŸ”„ å·¥ä½œåŸç†

æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š

1. **ç›‘æ§ç³»ç»Ÿå‘ç°é—®é¢˜** â†’ å¤œèºæ£€æµ‹åˆ°å‘Šè­¦äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šæœåŠ¡å™¨CPUä½¿ç”¨ç‡è¶…è¿‡80%ï¼‰
2. **æ‰“åŒ…å‘Šè­¦ä¿¡æ¯** â†’ å¤œèºå°†è¿™ä¸ªå‘Šè­¦çš„æ‰€æœ‰ä¿¡æ¯æ•´ç†æˆä¸€ä¸ªJSONæ ¼å¼çš„"åŒ…è£¹"
3. **è°ƒç”¨æ‚¨çš„è„šæœ¬** â†’ å¤œèºæ‰¾åˆ°æ‚¨æŒ‡å®šçš„è„šæœ¬ç¨‹åºï¼Œå¯åŠ¨å®ƒ
4. **ä¼ é€’æ•°æ®** â†’ å¤œèºå°†JSON"åŒ…è£¹"é€šè¿‡æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ä¼ ç»™æ‚¨çš„è„šæœ¬
5. **è„šæœ¬å¤„ç†** â†’ æ‚¨çš„è„šæœ¬æ”¶åˆ°æ•°æ®ï¼ŒæŒ‰ç…§æ‚¨çš„é€»è¾‘å‘é€é€šçŸ¥ï¼ˆæ¯”å¦‚å‘åˆ°é£ä¹¦ç¾¤ï¼‰

> ğŸ’¡ **å¥½å¤„**ï¼šå¤œèºå·²ç»å¸®æ‚¨å¤„ç†å¥½äº†å‘Šè­¦æ¨¡æ¿çš„æ¸²æŸ“ï¼Œè„šæœ¬æ”¶åˆ°çš„æ•°æ®æ˜¯æ ¼å¼åŒ–å¥½çš„ï¼Œæ‚¨åªéœ€è¦ä¸“æ³¨äº"æ€ä¹ˆå‘é€"è¿™ä¸€æ­¥ã€‚

## ğŸ“¦ æ‚¨çš„è„šæœ¬ä¼šæ”¶åˆ°ä»€ä¹ˆæ•°æ®ï¼Ÿ

å¤œèºä¼šé€šè¿‡æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰å‘æ‚¨çš„è„šæœ¬ä¼ é€’ä¸€ä¸ªJSONæ ¼å¼çš„æ•°æ®åŒ…ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```json
{
    "event": {
        "rule_name": "CPUä½¿ç”¨ç‡è¿‡é«˜",
        // ... æ›´å¤šå‘Šè­¦äº‹ä»¶çš„åŸå§‹æ•°æ®
    },
    "events": [
        // å¦‚æœæ˜¯èšåˆå‘Šè­¦ï¼ˆå¤šä¸ªäº‹ä»¶ä¸€èµ·å‘é€ï¼‰ï¼Œè¿™é‡Œä¼šåŒ…å«å¤šä¸ªäº‹ä»¶
        // æ¯ä¸ªäº‹ä»¶çš„ç»“æ„ä¸ä¸Šé¢çš„eventç›¸åŒ
    ],
    "tpl": {
        "title": "ã€å‘Šè­¦ã€‘CPUä½¿ç”¨ç‡è¿‡é«˜",
        "content": "æœåŠ¡å™¨ web-01 çš„CPUä½¿ç”¨ç‡è¾¾åˆ°85.6%ï¼Œå·²è¶…è¿‡é˜ˆå€¼80%ï¼Œè¯·åŠæ—¶å¤„ç†ï¼"
        // è¿™æ˜¯å¤œèºæ ¹æ®å‘Šè­¦æ¨¡æ¿æ¸²æŸ“å¥½çš„æœ€ç»ˆæ–‡æœ¬ï¼Œç›´æ¥å¯ç”¨
    },
    "params": {
        "access_token": "your_feishu_bot_token",
        "webhook_secret": "your_secret_key"
        // æ‚¨åœ¨ç•Œé¢é…ç½®çš„è‡ªå®šä¹‰å‚æ•°
    },
    "sendtos": ["138321xxxx", "135321xxxx"]
    // è¦å‘é€ç»™è°ï¼Œè¿™ä¸ªåˆ—è¡¨æ˜¯æ ¹æ®é€šçŸ¥è§„åˆ™ç¡®å®šçš„
}
```

> ğŸ’¡ **é‡ç‚¹ç†è§£**ï¼š`tpl` éƒ¨åˆ†æ˜¯å¤œèºå·²ç»æ¸²æŸ“å¥½çš„æ¶ˆæ¯å†…å®¹ï¼Œæ‚¨é€šå¸¸ç›´æ¥ä½¿ç”¨è¿™ä¸ªå†…å®¹å‘é€å³å¯ï¼Œæ— éœ€å†æ¬¡å¤„ç†æ¨¡æ¿ã€‚

## âš™ï¸ å˜é‡é…ç½®è¯¦è§£

åœ¨åˆ›å»ºè„šæœ¬é€šçŸ¥æ¸ é“æ—¶ï¼Œæ‚¨éœ€è¦é…ç½®ä¸¤ç§å˜é‡ï¼š

### 1ï¸âƒ£ è‡ªå®šä¹‰å‚æ•°ï¼ˆ$paramsï¼‰

**ä½œç”¨**ï¼šå­˜å‚¨è„šæœ¬è¿è¡Œæ—¶éœ€è¦çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚APIå¯†é’¥ã€è®¿é—®ä»¤ç‰Œç­‰ã€‚

**ä¸¾ä¸ªä¾‹å­**ï¼š
- ğŸ¯ **åœºæ™¯**ï¼šæ‚¨è¦å‘é€é£ä¹¦é€šçŸ¥ï¼Œéœ€è¦é£ä¹¦æœºå™¨äººçš„access_token
- ğŸ“ **é…ç½®æ­¥éª¤**ï¼š
  1. åœ¨"å˜é‡é…ç½®"ä¸­æ·»åŠ å‚æ•°æ ‡è¯†ï¼š`access_token`
  2. ç”¨æˆ·åœ¨é…ç½®é€šçŸ¥è§„åˆ™æ—¶ï¼Œä¼šçœ‹åˆ°éœ€è¦å¡«å…¥`access_token`çš„å€¼
  3. ç”¨æˆ·å¡«å…¥å®é™…çš„tokenï¼š`cli_a12b34c56d78e90f`
  4. è„šæœ¬è¿è¡Œæ—¶ï¼Œé€šè¿‡`params.access_token`å°±èƒ½è·å–åˆ°è¿™ä¸ªtoken

**å®é™…åº”ç”¨**ï¼š
```python
# åœ¨æ‚¨çš„è„šæœ¬ä¸­è¿™æ ·ä½¿ç”¨ï¼š
token = payload.get('params', {}).get('access_token')
url = f"https://open.feishu.cn/open-apis/bot/v2/hook/{token}"
```

### 2ï¸âƒ£ å‘é€ç›®æ ‡ï¼ˆ$sendtosï¼‰

**ä½œç”¨**ï¼šå®šä¹‰é€šçŸ¥è¦å‘é€ç»™å“ªäº›äººæˆ–ç¾¤ã€‚

**ä¸¾ä¸ªä¾‹å­**ï¼š
- ğŸ¯ **åœºæ™¯**ï¼šæ ¹æ®ä¸åŒå‘Šè­¦å‘é€ç»™ä¸åŒçš„äºº
- ğŸ“ **é…ç½®åŸç†**ï¼š
  1. åœ¨é€šçŸ¥è§„åˆ™ä¸­ï¼Œç®¡ç†å‘˜è®¾ç½®æŸä¸ªå‘Šè­¦è¦é€šçŸ¥"å¼ ä¸‰"å’Œ"è¿ç»´ç¾¤"
  2. ç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·é…ç½®çš„è”ç³»æ–¹å¼ï¼Œå°†"å¼ ä¸‰"è½¬æ¢ä¸ºä»–çš„æ‰‹æœºå·ï¼ˆæ ¹æ®å˜é‡é…ç½®ä¸­çš„è”ç³»æ–¹å¼æ¥å†³å®šè½¬æ¢ä¸ºä»€ä¹ˆï¼‰
  3. è„šæœ¬æ”¶åˆ°çš„`sendtos`æ•°ç»„å°±åŒ…å«äº†è¿™äº›å®é™…çš„æ‰‹æœºå·

**å®é™…åº”ç”¨**ï¼š
```python
# åœ¨æ‚¨çš„è„šæœ¬ä¸­éå†å‘é€ç›®æ ‡ï¼š
for target in payload.get('sendtos', []):
    send_notification_to(target, message)
```

## ğŸ› ï¸ è„šæœ¬é…ç½®æŒ‡å—

### â° è¶…æ—¶æ—¶é—´è®¾ç½®
- **å•ä½**ï¼šæ¯«ç§’ï¼ˆ1ç§’ = 1000æ¯«ç§’ï¼‰
- **ä½œç”¨**ï¼šé˜²æ­¢è„šæœ¬æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œé¿å…ç³»ç»Ÿå¡æ­»
- **å»ºè®®å€¼**ï¼š
  - ç®€å•è„šæœ¬ï¼š5000æ¯«ç§’ï¼ˆ5ç§’ï¼‰
  - å¤æ‚è„šæœ¬ï¼š10000æ¯«ç§’ï¼ˆ10ç§’ï¼‰
  - æœ‰ç½‘ç»œè¯·æ±‚ï¼š15000æ¯«ç§’ï¼ˆ15ç§’ï¼‰

### ğŸ“„ è„šæœ¬é…ç½®æ–¹å¼

æ‚¨å¯ä»¥é€‰æ‹©ä¸¤ç§æ–¹å¼æ¥é…ç½®è„šæœ¬ï¼š

#### æ–¹å¼1ï¼šç›´æ¥ç¼–å†™è„šæœ¬ï¼ˆæ¨èæ–°æ‰‹ä½¿ç”¨ï¼‰
- âœ… **ä¼˜ç‚¹**ï¼šåœ¨ç•Œé¢ä¸­ç›´æ¥ç¼–å†™ï¼Œæ–¹ä¾¿ä¿®æ”¹å’Œè°ƒè¯•
- âœ… **é€‚ç”¨åœºæ™¯**ï¼šè„šæœ¬å†…å®¹è¾ƒçŸ­ï¼Œé€»è¾‘ç®€å•
- ğŸ“ **æ“ä½œ**ï¼šé€‰æ‹©"ä½¿ç”¨è„šæœ¬"ï¼Œåœ¨æ–‡æœ¬æ¡†ä¸­ç¼–å†™æˆ–ç²˜è´´æ‚¨çš„è„šæœ¬ä»£ç 

#### æ–¹å¼2ï¼šä½¿ç”¨æœ¬åœ°è„šæœ¬æ–‡ä»¶
- âœ… **ä¼˜ç‚¹**ï¼šé€‚åˆå¤æ‚è„šæœ¬ï¼Œå¯ä»¥ä½¿ç”¨IDEå¼€å‘
- âœ… **é€‚ç”¨åœºæ™¯**ï¼šè„šæœ¬è¾ƒå¤§ï¼Œéœ€è¦å¼•ç”¨å¤šä¸ªæ–‡ä»¶
- ğŸ“ **æ“ä½œ**ï¼šé€‰æ‹©"ä½¿ç”¨è·¯å¾„"ï¼Œå¡«å…¥è„šæœ¬æ–‡ä»¶çš„å®Œæ•´è·¯å¾„

âš ï¸ **ä½¿ç”¨è·¯å¾„æ–¹å¼çš„æ³¨æ„äº‹é¡¹**ï¼š
1. **æ–‡ä»¶å­˜åœ¨**ï¼šç¡®ä¿è„šæœ¬æ–‡ä»¶å·²ä¿å­˜åˆ°æœåŠ¡å™¨æŒ‡å®šä½ç½®
2. **æ‰§è¡Œæƒé™**ï¼šè¿è¡Œ `chmod +x /path/to/your/script.py` ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
3. **ç”¨æˆ·æƒé™**ï¼šç¡®ä¿è¿è¡Œå¤œèºæœåŠ¡çš„ç”¨æˆ·èƒ½å¤Ÿè®¿é—®è¿™ä¸ªæ–‡ä»¶
4. **è·¯å¾„æ­£ç¡®**ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œå¦‚ï¼š`/opt/scripts/feishu_notify.py`

## ğŸ“ è„šæœ¬ç¤ºä¾‹

### ğŸš€ å…¥é—¨ç¤ºä¾‹ï¼šæœ€ç®€å•çš„æ—¥å¿—è®°å½•è„šæœ¬

å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨è„šæœ¬é€šçŸ¥ï¼Œå»ºè®®å…ˆä»è¿™ä¸ªç®€å•ä¾‹å­å¼€å§‹ï¼š

```python
#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
import sys
import json
from datetime import datetime

# è¯»å–å¤œèºä¼ å…¥çš„æ•°æ®
payload = json.load(sys.stdin)

# è·å–å‘Šè­¦ä¿¡æ¯
title = payload.get('tpl', {}).get('title', 'æœªçŸ¥å‘Šè­¦')
content = payload.get('tpl', {}).get('content', 'æœªçŸ¥å†…å®¹')
sendtos = payload.get('sendtos', [])

# ç”Ÿæˆæ—¥å¿—è®°å½•
timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
log_message = f"[{timestamp}] å‘Šè­¦é€šçŸ¥ï¼š{title}\nå†…å®¹ï¼š{content}\nå‘é€ç›®æ ‡ï¼š{', '.join(sendtos)}\n{'='*50}\n"

# å†™å…¥æ—¥å¿—æ–‡ä»¶
with open('/tmp/alerts.log', 'a', encoding='utf-8') as f:
    f.write(log_message)

print(f"å‘Šè­¦å·²è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œæ ‡é¢˜ï¼š{title}")
```

**è¿™ä¸ªè„šæœ¬çš„ä½œç”¨**ï¼š
- ğŸ“ å°†æ¯æ¬¡å‘Šè­¦è®°å½•åˆ° `/tmp/alerts.log` æ–‡ä»¶ä¸­
- ğŸ¯ å±•ç¤ºäº†å¦‚ä½•è¯»å–å’Œä½¿ç”¨å¤œèºä¼ å…¥çš„æ•°æ®
- âœ… ç®€å•å¯é ï¼Œé€‚åˆç”¨æ¥æµ‹è¯•è„šæœ¬é€šçŸ¥æ˜¯å¦æ­£å¸¸å·¥ä½œ

### ğŸ¯ è¿›é˜¶ç¤ºä¾‹ï¼šå‘é€é£ä¹¦é€šçŸ¥

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å®Œæ•´çš„Pythonè„šæœ¬ç¤ºä¾‹ï¼Œç”¨äºå¤„ç†å‘Šè­¦äº‹ä»¶å¹¶å‘é€åˆ°é£ä¹¦ï¼š

```python
#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
import sys
import json
import urllib.request
import urllib.parse
from urllib.error import URLError, HTTPError
import socket

def send_feishu_notification(payload):
    """
    å‘é€é£ä¹¦é€šçŸ¥çš„æ ¸å¿ƒå‡½æ•°ï¼ˆä½¿ç”¨æ ‡å‡†åº“ï¼Œæ— éœ€å®‰è£…ç¬¬ä¸‰æ–¹åº“ï¼‰
    """
    try:
        # 1. è·å–å¿…è¦ä¿¡æ¯
        token = payload.get('params', {}).get('access_token')
        title = payload.get('tpl', {}).get('title', 'ç³»ç»Ÿå‘Šè­¦')
        content = payload.get('tpl', {}).get('content', 'æœªçŸ¥å‘Šè­¦å†…å®¹')
        
        # 2. æ£€æŸ¥å¿…è¦å‚æ•°
        if not token:
            print("âŒ é”™è¯¯ï¼šæœªé…ç½®é£ä¹¦æœºå™¨äººaccess_token")
            return False
            
        # 3. æ„å»ºé£ä¹¦æ¶ˆæ¯æ ¼å¼
        feishu_message = {
            "msg_type": "text",
            "content": {
                "text": f"ğŸš¨ {title}\n\n{content}"
            }
        }
        
        # 4. å‡†å¤‡HTTPè¯·æ±‚
        url = f"https://open.feishu.cn/open-apis/bot/v2/hook/{token}"
        data = json.dumps(feishu_message).encode('utf-8')
        
        # 5. åˆ›å»ºè¯·æ±‚å¯¹è±¡
        req = urllib.request.Request(
            url,
            data=data,
            headers={'Content-Type': 'application/json;charset=utf-8'}
        )
        
        # 6. å‘é€è¯·æ±‚ï¼ˆè®¾ç½®10ç§’è¶…æ—¶ï¼‰
        with urllib.request.urlopen(req, timeout=10) as response:
            response_data = response.read().decode('utf-8')
            
            if response.status == 200:
                print("âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ")
                print(f"å“åº”å†…å®¹: {response_data}")
                return True
            else:
                print(f"âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥: HTTP {response.status}")
                print(f"å“åº”å†…å®¹: {response_data}")
                return False
                
    except socket.timeout:
        print("âŒ å‘é€é£ä¹¦é€šçŸ¥è¶…æ—¶")
        return False
    except HTTPError as e:
        print(f"âŒ HTTPè¯·æ±‚å¤±è´¥: {e.code} {e.reason}")
        return False
    except URLError as e:
        print(f"âŒ ç½‘ç»œè¿æ¥å¤±è´¥: {str(e.reason)}")
        return False
    except Exception as e:
        print(f"âŒ å‘é€é£ä¹¦é€šçŸ¥æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: {str(e)}")
        return False

def main():
    try:
        # è¯»å–å¤œèºä¼ å…¥çš„æ•°æ®
        payload = json.load(sys.stdin)
        
        # å¯é€‰ï¼šä¿å­˜æ•°æ®åˆ°æ–‡ä»¶ä¾›è°ƒè¯•ä½¿ç”¨
        # with open('/tmp/nightingale_payload.json', 'w', encoding='utf-8') as f:
        #     json.dump(payload, f, indent=2, ensure_ascii=False)
        
        # å‘é€é€šçŸ¥
        success = send_feishu_notification(payload)
        
        # æ ¹æ®ç»“æœè®¾ç½®é€€å‡ºç 
        sys.exit(0 if success else 1)
        
    except json.JSONDecodeError:
        print("âŒ é”™è¯¯ï¼šæ— æ³•è§£æè¾“å…¥çš„JSONæ•°æ®")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

**è¿™ä¸ªè„šæœ¬çš„ç‰¹ç‚¹**ï¼š
- ğŸ”§ **å®¹é”™æ€§å¥½**ï¼šåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†é€»è¾‘
- ğŸ“ **æ—¥å¿—æ¸…æ™°**ï¼šä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œæ¸…æ™°çš„æç¤ºä¿¡æ¯
- âš¡ **è¶…æ—¶æ§åˆ¶**ï¼šè®¾ç½®äº†10ç§’çš„ç½‘ç»œè¯·æ±‚è¶…æ—¶
- ğŸ” **ä¾¿äºè°ƒè¯•**ï¼šå¯é€‰æ‹©ä¿å­˜JSONæ•°æ®åˆ°æ–‡ä»¶
- âœ… **è¿”å›çŠ¶æ€ç **ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›1
- ğŸš€ **é›¶ä¾èµ–**ï¼šåªä½¿ç”¨ Python æ ‡å‡†åº“ï¼Œæ— éœ€å®‰è£…ç¬¬ä¸‰æ–¹åŒ…

**ä½¿ç”¨å‰å‡†å¤‡**ï¼š
1. âœ… **æ— éœ€å®‰è£…é¢å¤–ä¾èµ–**ï¼šè„šæœ¬åªä½¿ç”¨ Python æ ‡å‡†åº“
2. åœ¨å˜é‡é…ç½®ä¸­æ·»åŠ å‚æ•°ï¼š`access_token`
3. ç”¨æˆ·åœ¨é€šçŸ¥è§„åˆ™ä¸­å¡«å…¥é£ä¹¦æœºå™¨äººçš„å®é™…token     

## ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

### ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•

å½“è„šæœ¬é€šçŸ¥ä¸å·¥ä½œæ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. **åŸºç¡€æ£€æŸ¥**
   - [ ] è„šæœ¬è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Ÿ
   - [ ] Python ç‰ˆæœ¬æ˜¯å¦æ”¯æŒï¼Ÿï¼ˆå»ºè®® Python 3.6+ï¼‰
   - [ ] è¶…æ—¶æ—¶é—´è®¾ç½®æ˜¯å¦åˆç†ï¼Ÿ

2. **æƒé™æ£€æŸ¥**
   - [ ] è„šæœ¬æ˜¯å¦æœ‰æ‰§è¡Œæƒé™ï¼Ÿ
   - [ ] å¤œèºæœåŠ¡æ˜¯å¦èƒ½è®¿é—®è„šæœ¬æ–‡ä»¶ï¼Ÿ

3. **æ•°æ®æ£€æŸ¥**
   - [ ] å˜é‡é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ
   - [ ] ç”¨æˆ·æ˜¯å¦å¡«å†™äº†å¿…è¦çš„å‚æ•°ï¼Ÿ

### ğŸ› å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1ï¼šè„šæœ¬æ‰§è¡Œè¶…æ—¶ â°
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤ºè„šæœ¬æ‰§è¡Œè¶…æ—¶
**åŸå› **ï¼š
- è„šæœ¬æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†é…ç½®çš„è¶…æ—¶é™åˆ¶
- ç½‘ç»œè¯·æ±‚å“åº”æ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. é€‚å½“è°ƒæ•´è¶…æ—¶æ—¶é—´
# åœ¨ç•Œé¢ä¸­å°†è¶…æ—¶æ—¶é—´ä» 5000 è°ƒæ•´ä¸º 15000ï¼ˆ15ç§’ï¼‰

# 2. ä¼˜åŒ–è„šæœ¬ä¸­çš„ç½‘ç»œè¯·æ±‚è¶…æ—¶
# åœ¨ urllib.request.urlopen() ä¸­è®¾ç½®è¶…æ—¶
with urllib.request.urlopen(req, timeout=5) as response:  # è®¾ç½®5ç§’è¶…æ—¶
    pass
```

#### é—®é¢˜2ï¼šè„šæœ¬æ²¡æœ‰æ”¶åˆ°æ•°æ® ğŸ“¨
**ç—‡çŠ¶**ï¼šè„šæœ¬è¿è¡Œäº†ï¼Œä½†æ²¡æœ‰å¤„ç†ä»»ä½•æ•°æ®
**è°ƒè¯•æ–¹æ³•**ï¼š
```python
# åœ¨è„šæœ¬å¼€å¤´æ·»åŠ è°ƒè¯•ä»£ç 
import sys
import json

try:
    payload = json.load(sys.stdin)
    # å°†æ”¶åˆ°çš„æ•°æ®å†™å…¥æ–‡ä»¶
    with open('/tmp/debug_payload.json', 'w', encoding='utf-8') as f:
        json.dump(payload, f, indent=2, ensure_ascii=False)
    print("æ•°æ®å·²ä¿å­˜åˆ° /tmp/debug_payload.json")
except Exception as e:
    print(f"è¯»å–æ•°æ®å¤±è´¥: {e}")
```

#### é—®é¢˜3ï¼šå‚æ•°æ²¡æœ‰ä¼ é€’åˆ°è„šæœ¬ âš™ï¸
**ç—‡çŠ¶**ï¼š`params` ä¸ºç©ºæˆ–ç¼ºå°‘é¢„æœŸçš„å‚æ•°
**æ£€æŸ¥æ­¥éª¤**ï¼š
1. åœ¨è„šæœ¬é€šçŸ¥æ¸ é“é…ç½®ä¸­ï¼Œç¡®è®¤å·²æ·»åŠ å‚æ•°æ ‡è¯†ï¼ˆå¦‚ `access_token`ï¼‰
2. åœ¨é€šçŸ¥è§„åˆ™é…ç½®ä¸­ï¼Œç¡®è®¤ç”¨æˆ·å·²å¡«å†™å¯¹åº”å‚æ•°çš„å€¼
3. åœ¨è„šæœ¬ä¸­æ‰“å°å‚æ•°è¿›è¡Œç¡®è®¤ï¼š
```python
params = payload.get('params', {})
print(f"æ”¶åˆ°çš„å‚æ•°: {params}")
```

#### é—®é¢˜4ï¼šç½‘ç»œè¯·æ±‚å¤±è´¥ ğŸŒ
**ç—‡çŠ¶**ï¼šè„šæœ¬æ‰§è¡Œæ­£å¸¸ï¼Œä½†é€šçŸ¥æ²¡æœ‰å‘å‡º
**æ’æŸ¥æ–¹æ³•**ï¼š
```python
import urllib.request
import json
from urllib.error import URLError, HTTPError
import socket

try:
    # å‡†å¤‡è¯·æ±‚æ•°æ®
    req = urllib.request.Request(
        url,
        data=json.dumps(data).encode('utf-8'),
        headers={'Content-Type': 'application/json;charset=utf-8'}
    )
    
    with urllib.request.urlopen(req, timeout=10) as response:
        response_data = response.read().decode('utf-8')
        print(f"HTTPçŠ¶æ€ç : {response.status}")
        print(f"å“åº”å†…å®¹: {response_data}")
        
        if response.status != 200:
            print("âŒ è¯·æ£€æŸ¥APIåœ°å€å’Œå‚æ•°æ˜¯å¦æ­£ç¡®")
            
except socket.timeout:
    print("âŒ ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥")
except HTTPError as e:
    print(f"âŒ HTTPè¯·æ±‚å¤±è´¥: {e.code} {e.reason}")
except URLError as e:
    print(f"âŒ æ— æ³•è¿æ¥åˆ°ç›®æ ‡æœåŠ¡å™¨: {e.reason}")
```

### ğŸ§ª æ‰‹åŠ¨æµ‹è¯•è„šæœ¬

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨æµ‹è¯•æ‚¨çš„è„šæœ¬ï¼š

```bash
echo '{"event":{"rule_name":"æµ‹è¯•å‘Šè­¦"},"tpl":{"title":"æµ‹è¯•æ ‡é¢˜","content":"æµ‹è¯•å†…å®¹"},"params":{"access_token":"your_token"},"sendtos":["æµ‹è¯•ç”¨æˆ·"]}' | python3 /path/to/your/script.py
```

### ğŸ†˜ ä»ç„¶æ— æ³•è§£å†³ï¼Ÿ

å¦‚æœæŒ‰ç…§ä¸Šè¿°æ­¥éª¤ä»ç„¶æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯å¯»æ±‚å¸®åŠ©ï¼š

1. **è„šæœ¬å†…å®¹**ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯å¦‚tokenï¼‰
2. **é”™è¯¯æ—¥å¿—**çš„å®Œæ•´ä¿¡æ¯
3. **æµ‹è¯•å‘½ä»¤**çš„æ‰§è¡Œç»“æœ
4. **ç³»ç»Ÿç¯å¢ƒ**ä¿¡æ¯ï¼ˆPythonç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿç­‰ï¼‰

è¿™æ ·å¯ä»¥å¸®åŠ©æŠ€æœ¯æ”¯æŒäººå‘˜æ›´å¿«åœ°å®šä½å’Œè§£å†³é—®é¢˜ã€‚
