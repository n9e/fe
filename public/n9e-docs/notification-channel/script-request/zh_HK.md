# è…³æœ¬é€šçŸ¥ é…ç½®æŒ‡å—

## ğŸ“– ä»€éº¼æ˜¯è…³æœ¬é€šçŸ¥ï¼Ÿ

è…³æœ¬é€šçŸ¥æ˜¯å¤œé¶¯å¹³å°æä¾›çš„ä¸€ç¨®**é«˜åº¦éˆæ´»**çš„å‘Šè­¦æ¨é€æ–¹å¼ã€‚ç°¡å–®ä¾†èªªï¼Œç•¶ç³»çµ±å‡ºç¾å‘Šè­¦æ™‚ï¼Œå¤œé¶¯æœƒè‡ªå‹•èª¿ç”¨æ‚¨ç·¨å¯«çš„è…³æœ¬ç¨‹åºä¾†ç™¼é€é€šçŸ¥ã€‚

## ğŸš€ æ–°æ‰‹å¿«é€Ÿé–‹å§‹

å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨è…³æœ¬é€šçŸ¥ï¼Œå»ºè­°æŒ‰ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š

### ç¬¬1æ­¥ï¼šç¢ºèªæ˜¯å¦éœ€è¦è…³æœ¬é€šçŸ¥
è…³æœ¬é€šçŸ¥é©ç”¨æ–¼ä»¥ä¸‹å ´æ™¯ï¼š
- âœ… å…¬å¸ä½¿ç”¨çš„é€šçŸ¥å·¥å…·ä¸åœ¨å¤œé¶¯å…§ç½®æ¸…å–®ä¸­ï¼ˆå¦‚ä¼å¾®ã€é‡˜é‡˜ç­‰å·²å…§ç½®ï¼‰
- âœ… éœ€è¦è¤‡é›œçš„æ•¸æ“šè™•ç†æˆ–æ ¼å¼è½‰æ›
- âœ… éœ€è¦åŒæ™‚ç™¼é€åˆ°å¤šå€‹ä¸åŒç®¡é“

### ç¬¬2æ­¥ï¼šæº–å‚™æ¸¬è©¦ç’°å¢ƒ
1. **å…ˆç”¨ç°¡å–®è…³æœ¬æ¸¬è©¦**ï¼ˆè¤‡è£½æœ¬æ–‡æª”ä¸­çš„ã€Œå…¥é–€ç¤ºä¾‹ã€ï¼‰
2. **ç¢ºèªæ•¸æ“šæµé€š**ï¼ˆæª¢æŸ¥æ—¥èªŒæ–‡ä»¶æ˜¯å¦æœ‰å…§å®¹ï¼‰
3. **å†æ”¹ç‚ºå¯¦éš›é€šçŸ¥**ï¼ˆä¿®æ”¹ç‚ºé£›æ›¸/ä¼å¾®/å…§éƒ¨ IM ç­‰çœŸå¯¦é€šçŸ¥ï¼‰

### ç¬¬3æ­¥ï¼šé…ç½®é€šçŸ¥æ¸ é“
1. åœ¨å¤œé¶¯ç•Œé¢å‰µå»ºã€Œè…³æœ¬é€šçŸ¥ã€é¡å‹çš„é€šçŸ¥æ¸ é“
2. é…ç½®å¿…è¦çš„è®Šæ•¸ï¼ˆå¦‚ `access_token`ï¼‰
3. é¸æ“‡è…³æœ¬é…ç½®æ–¹å¼ï¼ˆå»ºè­°æ–°æ‰‹é¸æ“‡ã€Œä½¿ç”¨è…³æœ¬ã€ç›´æ¥ç·¨å¯«ï¼‰

### ç¬¬4æ­¥ï¼šæ¸¬è©¦é©—è­‰
1. æ‰‹å‹•æ¸¬è©¦è…³æœ¬ï¼ˆåƒè€ƒæ–‡æª”æœ«å°¾çš„æ¸¬è©¦æ–¹æ³•ï¼‰
2. å‰µå»ºæ¸¬è©¦å‘Šè­¦è¦å‰‡é—œè¯è©²é€šçŸ¥æ¸ é“
3. è§¸ç™¼å‘Šè­¦é©—è­‰é€šçŸ¥æ˜¯å¦æ­£å¸¸

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šå¼·çƒˆå»ºè­°å…ˆä½¿ç”¨å…¥é–€ç¤ºä¾‹ä¸­çš„æ—¥èªŒè¨˜éŒ„è…³æœ¬é€²è¡Œæ¸¬è©¦ï¼Œç¢ºèªæ•¸æ“šå‚³éæ­£å¸¸å¾Œï¼Œå†ä¿®æ”¹ç‚ºå¯¦éš›çš„é€šçŸ¥é‚è¼¯ã€‚

## ğŸ”„ å·¥ä½œåŸç†

æƒ³åƒä¸€ä¸‹é€™å€‹éç¨‹ï¼š

1. **ç›£æ§ç³»çµ±ç™¼ç¾å•é¡Œ** â†’ å¤œé¶¯æª¢æ¸¬åˆ°å‘Šè­¦äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šæœå‹™å™¨CPUä½¿ç”¨ç‡è¶…é80%ï¼‰
2. **æ‰“åŒ…å‘Šè­¦ä¿¡æ¯** â†’ å¤œé¶¯å°‡é€™å€‹å‘Šè­¦çš„æ‰€æœ‰ä¿¡æ¯æ•´ç†æˆä¸€å€‹JSONæ ¼å¼çš„ã€ŒåŒ…è£¹ã€
3. **èª¿ç”¨æ‚¨çš„è…³æœ¬** â†’ å¤œé¶¯æ‰¾åˆ°æ‚¨æŒ‡å®šçš„è…³æœ¬ç¨‹åºï¼Œå•Ÿå‹•å®ƒ
4. **å‚³éæ•¸æ“š** â†’ å¤œé¶¯å°‡JSONã€ŒåŒ…è£¹ã€é€šéæ¨™æº–è¼¸å…¥ï¼ˆstdinï¼‰å‚³çµ¦æ‚¨çš„è…³æœ¬
5. **è…³æœ¬è™•ç†** â†’ æ‚¨çš„è…³æœ¬æ”¶åˆ°æ•¸æ“šï¼ŒæŒ‰ç…§æ‚¨çš„é‚è¼¯ç™¼é€é€šçŸ¥ï¼ˆæ¯”å¦‚ç™¼åˆ°é£›æ›¸ç¾¤ï¼‰

> ğŸ’¡ **å¥½è™•**ï¼šå¤œé¶¯å·²ç¶“å¹«æ‚¨è™•ç†å¥½äº†å‘Šè­¦æ¨¡æ¿çš„æ¸²æŸ“ï¼Œè…³æœ¬æ”¶åˆ°çš„æ•¸æ“šæ˜¯æ ¼å¼åŒ–å¥½çš„ï¼Œæ‚¨åªéœ€è¦å°ˆæ³¨æ–¼ã€Œæ€éº¼ç™¼é€ã€é€™ä¸€æ­¥ã€‚

## ğŸ“¦ æ‚¨çš„è…³æœ¬æœƒæ”¶åˆ°ä»€éº¼æ•¸æ“šï¼Ÿ

å¤œé¶¯æœƒé€šéæ¨™æº–è¼¸å…¥ï¼ˆstdinï¼‰å‘æ‚¨çš„è…³æœ¬å‚³éä¸€å€‹JSONæ ¼å¼çš„æ•¸æ“šåŒ…ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```json
{
    "event": {
        "rule_name": "CPUä½¿ç”¨ç‡éé«˜",
        // ... æ›´å¤šå‘Šè­¦äº‹ä»¶çš„åŸå§‹æ•¸æ“š
    },
    "events": [
        // å¦‚æœæ˜¯èšåˆå‘Šè­¦ï¼ˆå¤šå€‹äº‹ä»¶ä¸€èµ·ç™¼é€ï¼‰ï¼Œé€™è£¡æœƒåŒ…å«å¤šå€‹äº‹ä»¶
        // æ¯å€‹äº‹ä»¶çš„çµæ§‹èˆ‡ä¸Šé¢çš„eventç›¸åŒ
    ],
    "tpl": {
        "title": "ã€å‘Šè­¦ã€‘CPUä½¿ç”¨ç‡éé«˜",
        "content": "æœå‹™å™¨ web-01 çš„CPUä½¿ç”¨ç‡é”åˆ°85.6%ï¼Œå·²è¶…éé–¾å€¼80%ï¼Œè«‹åŠæ™‚è™•ç†ï¼"
        // é€™æ˜¯å¤œé¶¯æ ¹æ“šå‘Šè­¦æ¨¡æ¿æ¸²æŸ“å¥½çš„æœ€çµ‚æ–‡æœ¬ï¼Œç›´æ¥å¯ç”¨
    },
    "params": {
        "access_token": "your_feishu_bot_token",
        "webhook_secret": "your_secret_key"
        // æ‚¨åœ¨ç•Œé¢é…ç½®çš„è‡ªå®šç¾©åƒæ•¸
    },
    "sendtos": ["138321xxxx", "135321xxxx"]
    // è¦ç™¼é€çµ¦èª°ï¼Œé€™å€‹æ¸…å–®æ˜¯æ ¹æ“šé€šçŸ¥è¦å‰‡ç¢ºå®šçš„
}
```

> ğŸ’¡ **é‡é»ç†è§£**ï¼š`tpl` éƒ¨åˆ†æ˜¯å¤œé¶¯å·²ç¶“æ¸²æŸ“å¥½çš„æ¶ˆæ¯å…§å®¹ï¼Œæ‚¨é€šå¸¸ç›´æ¥ä½¿ç”¨é€™å€‹å…§å®¹ç™¼é€å³å¯ï¼Œç„¡éœ€å†æ¬¡è™•ç†æ¨¡æ¿ã€‚

## âš™ï¸ è®Šæ•¸é…ç½®è©³è§£

åœ¨å‰µå»ºè…³æœ¬é€šçŸ¥æ¸ é“æ™‚ï¼Œæ‚¨éœ€è¦é…ç½®å…©ç¨®è®Šæ•¸ï¼š

### 1ï¸âƒ£ è‡ªå®šç¾©åƒæ•¸ï¼ˆ$paramsï¼‰

**ä½œç”¨**ï¼šå­˜å„²è…³æœ¬é‹è¡Œæ™‚éœ€è¦çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚APIå¯†é‘°ã€å­˜å–ä»¤ç‰Œç­‰ã€‚

**èˆ‰å€‹ä¾‹å­**ï¼š
- ğŸ¯ **å ´æ™¯**ï¼šæ‚¨è¦ç™¼é€é£›æ›¸é€šçŸ¥ï¼Œéœ€è¦é£›æ›¸æ©Ÿå™¨äººçš„access_token
- ğŸ“ **é…ç½®æ­¥é©Ÿ**ï¼š
  1. åœ¨ã€Œè®Šæ•¸é…ç½®ã€ä¸­æ·»åŠ åƒæ•¸æ¨™è­˜ï¼š`access_token`
  2. ç”¨æˆ¶åœ¨é…ç½®é€šçŸ¥è¦å‰‡æ™‚ï¼Œæœƒçœ‹åˆ°éœ€è¦å¡«å…¥`access_token`çš„å€¼
  3. ç”¨æˆ¶å¡«å…¥å¯¦éš›çš„tokenï¼š`cli_a12b34c56d78e90f`
  4. è…³æœ¬é‹è¡Œæ™‚ï¼Œé€šé`params.access_token`å°±èƒ½ç²å–åˆ°é€™å€‹token

**å¯¦éš›æ‡‰ç”¨**ï¼š
```python
# åœ¨æ‚¨çš„è…³æœ¬ä¸­é€™æ¨£ä½¿ç”¨ï¼š
token = payload.get('params', {}).get('access_token')
url = f"https://open.feishu.cn/open-apis/bot/v2/hook/{token}"
```

### 2ï¸âƒ£ ç™¼é€ç›®æ¨™ï¼ˆ$sendtosï¼‰

**ä½œç”¨**ï¼šå®šç¾©é€šçŸ¥è¦ç™¼é€çµ¦å“ªäº›äººæˆ–ç¾¤ã€‚

**èˆ‰å€‹ä¾‹å­**ï¼š
- ğŸ¯ **å ´æ™¯**ï¼šæ ¹æ“šä¸åŒå‘Šè­¦ç™¼é€çµ¦ä¸åŒçš„äºº
- ğŸ“ **é…ç½®åŸç†**ï¼š
  1. åœ¨é€šçŸ¥è¦å‰‡ä¸­ï¼Œç®¡ç†å“¡è¨­ç½®æŸå€‹å‘Šè­¦è¦é€šçŸ¥ã€Œå¼µä¸‰ã€å’Œã€Œé‹ç¶­ç¾¤ã€
  2. ç³»çµ±æœƒæ ¹æ“šç”¨æˆ¶é…ç½®çš„è¯ç¹«æ–¹å¼ï¼Œå°‡ã€Œå¼µä¸‰ã€è½‰æ›ç‚ºä»–çš„æ‰‹æ©Ÿè™Ÿï¼ˆæ ¹æ“šè®Šæ•¸é…ç½®ä¸­çš„è¯ç¹«æ–¹å¼ä¾†æ±ºå®šè½‰æ›ç‚ºä»€éº¼ï¼‰
  3. è…³æœ¬æ”¶åˆ°çš„`sendtos`é™£åˆ—å°±åŒ…å«äº†é€™äº›å¯¦éš›çš„æ‰‹æ©Ÿè™Ÿ

**å¯¦éš›æ‡‰ç”¨**ï¼š
```python
# åœ¨æ‚¨çš„è…³æœ¬ä¸­éæ­·ç™¼é€ç›®æ¨™ï¼š
for target in payload.get('sendtos', []):
    send_notification_to(target, message)
```

## ğŸ› ï¸ è…³æœ¬é…ç½®æŒ‡å—

### â° è¶…æ™‚æ™‚é–“è¨­ç½®
- **å–®ä½**ï¼šæ¯«ç§’ï¼ˆ1ç§’ = 1000æ¯«ç§’ï¼‰
- **ä½œç”¨**ï¼šé˜²æ­¢è…³æœ¬åŸ·è¡Œæ™‚é–“éé•·ï¼Œé¿å…ç³»çµ±å¡æ­»
- **å»ºè­°å€¼**ï¼š
  - ç°¡å–®è…³æœ¬ï¼š5000æ¯«ç§’ï¼ˆ5ç§’ï¼‰
  - è¤‡é›œè…³æœ¬ï¼š10000æ¯«ç§’ï¼ˆ10ç§’ï¼‰
  - æœ‰ç¶²çµ¡è«‹æ±‚ï¼š15000æ¯«ç§’ï¼ˆ15ç§’ï¼‰

### ğŸ“„ è…³æœ¬é…ç½®æ–¹å¼

æ‚¨å¯ä»¥é¸æ“‡å…©ç¨®æ–¹å¼ä¾†é…ç½®è…³æœ¬ï¼š

#### æ–¹å¼1ï¼šç›´æ¥ç·¨å¯«è…³æœ¬ï¼ˆæ¨è–¦æ–°æ‰‹ä½¿ç”¨ï¼‰
- âœ… **å„ªé»**ï¼šåœ¨ç•Œé¢ä¸­ç›´æ¥ç·¨å¯«ï¼Œæ–¹ä¾¿ä¿®æ”¹å’Œèª¿è©¦
- âœ… **é©ç”¨å ´æ™¯**ï¼šè…³æœ¬å…§å®¹è¼ƒçŸ­ï¼Œé‚è¼¯ç°¡å–®
- ğŸ“ **æ“ä½œ**ï¼šé¸æ“‡ã€Œä½¿ç”¨è…³æœ¬ã€ï¼Œåœ¨æ–‡å­—æ–¹å¡Šä¸­ç·¨å¯«æˆ–ç²˜è²¼æ‚¨çš„è…³æœ¬ä»£ç¢¼

#### æ–¹å¼2ï¼šä½¿ç”¨æœ¬åœ°è…³æœ¬æ–‡ä»¶
- âœ… **å„ªé»**ï¼šé©åˆè¤‡é›œè…³æœ¬ï¼Œå¯ä»¥ä½¿ç”¨IDEé–‹ç™¼
- âœ… **é©ç”¨å ´æ™¯**ï¼šè…³æœ¬è¼ƒå¤§ï¼Œéœ€è¦å¼•ç”¨å¤šå€‹æ–‡ä»¶
- ğŸ“ **æ“ä½œ**ï¼šé¸æ“‡ã€Œä½¿ç”¨è·¯å¾‘ã€ï¼Œå¡«å…¥è…³æœ¬æ–‡ä»¶çš„å®Œæ•´è·¯å¾‘

âš ï¸ **ä½¿ç”¨è·¯å¾‘æ–¹å¼çš„æ³¨æ„äº‹é …**ï¼š
1. **æ–‡ä»¶å­˜åœ¨**ï¼šç¢ºä¿è…³æœ¬æ–‡ä»¶å·²ä¿å­˜åˆ°æœå‹™å™¨æŒ‡å®šä½ç½®
2. **åŸ·è¡Œæ¬Šé™**ï¼šé‹è¡Œ `chmod +x /path/to/your/script.py` çµ¦è…³æœ¬æ·»åŠ åŸ·è¡Œæ¬Šé™
3. **ç”¨æˆ¶æ¬Šé™**ï¼šç¢ºä¿é‹è¡Œå¤œé¶¯æœå‹™çš„ç”¨æˆ¶èƒ½å¤ è¨ªå•é€™å€‹æ–‡ä»¶
4. **è·¯å¾‘æ­£ç¢º**ï¼šä½¿ç”¨çµ•å°è·¯å¾‘ï¼Œå¦‚ï¼š`/opt/scripts/feishu_notify.py`

## ğŸ“ è…³æœ¬ç¤ºä¾‹

### ğŸš€ å…¥é–€ç¤ºä¾‹ï¼šæœ€ç°¡å–®çš„æ—¥èªŒè¨˜éŒ„è…³æœ¬

å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨è…³æœ¬é€šçŸ¥ï¼Œå»ºè­°å…ˆå¾é€™å€‹ç°¡å–®ä¾‹å­é–‹å§‹ï¼š

```python
#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
import sys
import json
from datetime import datetime

# è®€å–å¤œé¶¯å‚³å…¥çš„æ•¸æ“š
payload = json.load(sys.stdin)

# ç²å–å‘Šè­¦ä¿¡æ¯
title = payload.get('tpl', {}).get('title', 'æœªçŸ¥å‘Šè­¦')
content = payload.get('tpl', {}).get('content', 'æœªçŸ¥å…§å®¹')
sendtos = payload.get('sendtos', [])

# ç”Ÿæˆæ—¥èªŒè¨˜éŒ„
timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
log_message = f"[{timestamp}] å‘Šè­¦é€šçŸ¥ï¼š{title}\nå…§å®¹ï¼š{content}\nç™¼é€ç›®æ¨™ï¼š{', '.join(sendtos)}\n{'='*50}\n"

# å¯«å…¥æ—¥èªŒæ–‡ä»¶
with open('/tmp/alerts.log', 'a', encoding='utf-8') as f:
    f.write(log_message)

print(f"å‘Šè­¦å·²è¨˜éŒ„åˆ°æ—¥èªŒæ–‡ä»¶ï¼Œæ¨™é¡Œï¼š{title}")
```

**é€™å€‹è…³æœ¬çš„ä½œç”¨**ï¼š
- ğŸ“ å°‡æ¯æ¬¡å‘Šè­¦è¨˜éŒ„åˆ° `/tmp/alerts.log` æ–‡ä»¶ä¸­
- ğŸ¯ å±•ç¤ºäº†å¦‚ä½•è®€å–å’Œä½¿ç”¨å¤œé¶¯å‚³å…¥çš„æ•¸æ“š
- âœ… ç°¡å–®å¯é ï¼Œé©åˆç”¨ä¾†æ¸¬è©¦è…³æœ¬é€šçŸ¥æ˜¯å¦æ­£å¸¸å·¥ä½œ

### ğŸ¯ é€²éšç¤ºä¾‹ï¼šç™¼é€é£›æ›¸é€šçŸ¥

ä»¥ä¸‹æ˜¯ä¸€å€‹æ›´å®Œæ•´çš„Pythonè…³æœ¬ç¤ºä¾‹ï¼Œç”¨æ–¼è™•ç†å‘Šè­¦äº‹ä»¶ä¸¦ç™¼é€åˆ°é£›æ›¸ï¼š

```python
#!/usr/bin/env python3
# -*- coding: UTF-8 -*-
import sys
import json
import urllib.request
import urllib.parse
from urllib.error import URLError, HTTPError
import socket

def send_feishu_notification(payload):
    """
    ç™¼é€é£›æ›¸é€šçŸ¥çš„æ ¸å¿ƒå‡½æ•¸ï¼ˆä½¿ç”¨æ¨™æº–åº«ï¼Œç„¡éœ€å®‰è£ç¬¬ä¸‰æ–¹åº«ï¼‰
    """
    try:
        # 1. ç²å–å¿…è¦ä¿¡æ¯
        token = payload.get('params', {}).get('access_token')
        title = payload.get('tpl', {}).get('title', 'ç³»çµ±å‘Šè­¦')
        content = payload.get('tpl', {}).get('content', 'æœªçŸ¥å‘Šè­¦å…§å®¹')
        
        # 2. æª¢æŸ¥å¿…è¦åƒæ•¸
        if not token:
            print("âŒ éŒ¯èª¤ï¼šæœªé…ç½®é£›æ›¸æ©Ÿå™¨äººaccess_token")
            return False
            
        # 3. æ§‹å»ºé£›æ›¸æ¶ˆæ¯æ ¼å¼
        feishu_message = {
            "msg_type": "text",
            "content": {
                "text": f"ğŸš¨ {title}\n\n{content}"
            }
        }
        
        # 4. æº–å‚™HTTPè«‹æ±‚
        url = f"https://open.feishu.cn/open-apis/bot/v2/hook/{token}"
        data = json.dumps(feishu_message).encode('utf-8')
        
        # 5. å‰µå»ºè«‹æ±‚å°è±¡
        req = urllib.request.Request(
            url,
            data=data,
            headers={'Content-Type': 'application/json;charset=utf-8'}
        )
        
        # 6. ç™¼é€è«‹æ±‚ï¼ˆè¨­ç½®10ç§’è¶…æ™‚ï¼‰
        with urllib.request.urlopen(req, timeout=10) as response:
            response_data = response.read().decode('utf-8')
            
            if response.status == 200:
                print("âœ… é£›æ›¸é€šçŸ¥ç™¼é€æˆåŠŸ")
                print(f"å›æ‡‰å…§å®¹: {response_data}")
                return True
            else:
                print(f"âŒ é£›æ›¸é€šçŸ¥ç™¼é€å¤±æ•—: HTTP {response.status}")
                print(f"å›æ‡‰å…§å®¹: {response_data}")
                return False
                
    except socket.timeout:
        print("âŒ ç™¼é€é£›æ›¸é€šçŸ¥è¶…æ™‚")
        return False
    except HTTPError as e:
        print(f"âŒ HTTPè«‹æ±‚å¤±æ•—: {e.code} {e.reason}")
        return False
    except URLError as e:
        print(f"âŒ ç¶²çµ¡é€£æ¥å¤±æ•—: {str(e.reason)}")
        return False
    except Exception as e:
        print(f"âŒ ç™¼é€é£›æ›¸é€šçŸ¥æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: {str(e)}")
        return False

def main():
    try:
        # è®€å–å¤œé¶¯å‚³å…¥çš„æ•¸æ“š
        payload = json.load(sys.stdin)
        
        # å¯é¸ï¼šä¿å­˜æ•¸æ“šåˆ°æ–‡ä»¶ä¾›èª¿è©¦ä½¿ç”¨
        # with open('/tmp/nightingale_payload.json', 'w', encoding='utf-8') as f:
        #     json.dump(payload, f, indent=2, ensure_ascii=False)
        
        # ç™¼é€é€šçŸ¥
        success = send_feishu_notification(payload)
        
        # æ ¹æ“šçµæœè¨­ç½®é€€å‡ºç¢¼
        sys.exit(0 if success else 1)
        
    except json.JSONDecodeError:
        print("âŒ éŒ¯èª¤ï¼šç„¡æ³•è§£æè¼¸å…¥çš„JSONæ•¸æ“š")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ è…³æœ¬åŸ·è¡Œå¤±æ•—: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

**é€™å€‹è…³æœ¬çš„ç‰¹é»**ï¼š
- ğŸ”§ **å®¹éŒ¯æ€§å¥½**ï¼šåŒ…å«å®Œæ•´çš„éŒ¯èª¤è™•ç†é‚è¼¯
- ğŸ“ **æ—¥èªŒæ¸…æ™°**ï¼šä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿå’Œæ¸…æ™°çš„æç¤ºä¿¡æ¯
- âš¡ **è¶…æ™‚æ§åˆ¶**ï¼šè¨­ç½®äº†10ç§’çš„ç¶²çµ¡è«‹æ±‚è¶…æ™‚
- ğŸ” **ä¾¿æ–¼èª¿è©¦**ï¼šå¯é¸æ“‡ä¿å­˜JSONæ•¸æ“šåˆ°æ–‡ä»¶
- âœ… **è¿”å›ç‹€æ…‹ç¢¼**ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±æ•—è¿”å›1
- ğŸš€ **é›¶ä¾è³´**ï¼šåªä½¿ç”¨ Python æ¨™æº–åº«ï¼Œç„¡éœ€å®‰è£ç¬¬ä¸‰æ–¹åŒ…

**ä½¿ç”¨å‰æº–å‚™**ï¼š
1. âœ… **ç„¡éœ€å®‰è£é¡å¤–ä¾è³´**ï¼šè…³æœ¬åªä½¿ç”¨ Python æ¨™æº–åº«
2. åœ¨è®Šæ•¸é…ç½®ä¸­æ·»åŠ åƒæ•¸ï¼š`access_token`
3. ç”¨æˆ¶åœ¨é€šçŸ¥è¦å‰‡ä¸­å¡«å…¥é£›æ›¸æ©Ÿå™¨äººçš„å¯¦éš›token     

## ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

### ğŸ“‹ å¿«é€Ÿæª¢æŸ¥æ¸…å–®

ç•¶è…³æœ¬é€šçŸ¥ä¸å·¥ä½œæ™‚ï¼ŒæŒ‰ä»¥ä¸‹é †åºæª¢æŸ¥ï¼š

1. **åŸºç¤æª¢æŸ¥**
   - [ ] è…³æœ¬èªæ³•æ˜¯å¦æ­£ç¢ºï¼Ÿ
   - [ ] Python ç‰ˆæœ¬æ˜¯å¦æ”¯æŒï¼Ÿï¼ˆå»ºè­° Python 3.6+ï¼‰
   - [ ] è¶…æ™‚æ™‚é–“è¨­ç½®æ˜¯å¦åˆç†ï¼Ÿ

2. **æ¬Šé™æª¢æŸ¥**
   - [ ] è…³æœ¬æ˜¯å¦æœ‰åŸ·è¡Œæ¬Šé™ï¼Ÿ
   - [ ] å¤œé¶¯æœå‹™æ˜¯å¦èƒ½è¨ªå•è…³æœ¬æ–‡ä»¶ï¼Ÿ

3. **æ•¸æ“šæª¢æŸ¥**
   - [ ] è®Šæ•¸é…ç½®æ˜¯å¦æ­£ç¢ºï¼Ÿ
   - [ ] ç”¨æˆ¶æ˜¯å¦å¡«å¯«äº†å¿…è¦çš„åƒæ•¸ï¼Ÿ

### ğŸ› å¸¸è¦‹å•é¡Œè§£æ±ºæ–¹æ¡ˆ

#### å•é¡Œ1ï¼šè…³æœ¬åŸ·è¡Œè¶…æ™‚ â°
**ç—‡ç‹€**ï¼šæ—¥èªŒé¡¯ç¤ºè…³æœ¬åŸ·è¡Œè¶…æ™‚
**åŸå› **ï¼š
- è…³æœ¬åŸ·è¡Œæ™‚é–“è¶…éäº†é…ç½®çš„è¶…æ™‚é™åˆ¶
- ç¶²çµ¡è«‹æ±‚å›æ‡‰æ…¢

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```bash
# 1. é©ç•¶èª¿æ•´è¶…æ™‚æ™‚é–“
# åœ¨ç•Œé¢ä¸­å°‡è¶…æ™‚æ™‚é–“å¾ 5000 èª¿æ•´ç‚º 15000ï¼ˆ15ç§’ï¼‰

# 2. å„ªåŒ–è…³æœ¬ä¸­çš„ç¶²çµ¡è«‹æ±‚è¶…æ™‚
# åœ¨ urllib.request.urlopen() ä¸­è¨­ç½®è¶…æ™‚
with urllib.request.urlopen(req, timeout=5) as response:  # è¨­ç½®5ç§’è¶…æ™‚
    pass
```

#### å•é¡Œ2ï¼šè…³æœ¬æ²’æœ‰æ”¶åˆ°æ•¸æ“š ğŸ“¨
**ç—‡ç‹€**ï¼šè…³æœ¬é‹è¡Œäº†ï¼Œä½†æ²’æœ‰è™•ç†ä»»ä½•æ•¸æ“š
**èª¿è©¦æ–¹æ³•**ï¼š
```python
# åœ¨è…³æœ¬é–‹é ­æ·»åŠ èª¿è©¦ä»£ç¢¼
import sys
import json

try:
    payload = json.load(sys.stdin)
    # å°‡æ”¶åˆ°çš„æ•¸æ“šå¯«å…¥æ–‡ä»¶
    with open('/tmp/debug_payload.json', 'w', encoding='utf-8') as f:
        json.dump(payload, f, indent=2, ensure_ascii=False)
    print("æ•¸æ“šå·²ä¿å­˜åˆ° /tmp/debug_payload.json")
except Exception as e:
    print(f"è®€å–æ•¸æ“šå¤±æ•—: {e}")
```

#### å•é¡Œ3ï¼šåƒæ•¸æ²’æœ‰å‚³éåˆ°è…³æœ¬ âš™ï¸
**ç—‡ç‹€**ï¼š`params` ç‚ºç©ºæˆ–ç¼ºå°‘é æœŸçš„åƒæ•¸
**æª¢æŸ¥æ­¥é©Ÿ**ï¼š
1. åœ¨è…³æœ¬é€šçŸ¥æ¸ é“é…ç½®ä¸­ï¼Œç¢ºèªå·²æ·»åŠ åƒæ•¸æ¨™è­˜ï¼ˆå¦‚ `access_token`ï¼‰
2. åœ¨é€šçŸ¥è¦å‰‡é…ç½®ä¸­ï¼Œç¢ºèªç”¨æˆ¶å·²å¡«å¯«å°æ‡‰åƒæ•¸çš„å€¼
3. åœ¨è…³æœ¬ä¸­æ‰“å°åƒæ•¸é€²è¡Œç¢ºèªï¼š
```python
params = payload.get('params', {})
print(f"æ”¶åˆ°çš„åƒæ•¸: {params}")
```

#### å•é¡Œ4ï¼šç¶²çµ¡è«‹æ±‚å¤±æ•— ğŸŒ
**ç—‡ç‹€**ï¼šè…³æœ¬åŸ·è¡Œæ­£å¸¸ï¼Œä½†é€šçŸ¥æ²’æœ‰ç™¼å‡º
**æ’æŸ¥æ–¹æ³•**ï¼š
```python
import urllib.request
import json
from urllib.error import URLError, HTTPError
import socket

try:
    # æº–å‚™è«‹æ±‚æ•¸æ“š
    req = urllib.request.Request(
        url,
        data=json.dumps(data).encode('utf-8'),
        headers={'Content-Type': 'application/json;charset=utf-8'}
    )
    
    with urllib.request.urlopen(req, timeout=10) as response:
        response_data = response.read().decode('utf-8')
        print(f"HTTPç‹€æ…‹ç¢¼: {response.status}")
        print(f"å›æ‡‰å…§å®¹: {response_data}")
        
        if response.status != 200:
            print("âŒ è«‹æª¢æŸ¥APIåœ°å€å’Œåƒæ•¸æ˜¯å¦æ­£ç¢º")
            
except socket.timeout:
    print("âŒ ç¶²çµ¡è«‹æ±‚è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥")
except HTTPError as e:
    print(f"âŒ HTTPè«‹æ±‚å¤±æ•—: {e.code} {e.reason}")
except URLError as e:
    print(f"âŒ ç„¡æ³•é€£æ¥åˆ°ç›®æ¨™æœå‹™å™¨: {e.reason}")
```

### ğŸ§ª æ‰‹å‹•æ¸¬è©¦è…³æœ¬

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰‹å‹•æ¸¬è©¦æ‚¨çš„è…³æœ¬ï¼š

```bash
echo '{"event":{"rule_name":"æ¸¬è©¦å‘Šè­¦"},"tpl":{"title":"æ¸¬è©¦æ¨™é¡Œ","content":"æ¸¬è©¦å…§å®¹"},"params":{"access_token":"your_token"},"sendtos":["æ¸¬è©¦ç”¨æˆ¶"]}' | python3 /path/to/your/script.py
```

### ğŸ†˜ ä»ç„¶ç„¡æ³•è§£æ±ºï¼Ÿ

å¦‚æœæŒ‰ç…§ä¸Šè¿°æ­¥é©Ÿä»ç„¶ç„¡æ³•è§£æ±ºå•é¡Œï¼Œè«‹æ”¶é›†ä»¥ä¸‹ä¿¡æ¯å°‹æ±‚å¹«åŠ©ï¼š

1. **è…³æœ¬å…§å®¹**ï¼ˆéš±è—æ•æ„Ÿä¿¡æ¯å¦‚tokenï¼‰
2. **éŒ¯èª¤æ—¥èªŒ**çš„å®Œæ•´ä¿¡æ¯
3. **æ¸¬è©¦å‘½ä»¤**çš„åŸ·è¡Œçµæœ
4. **ç³»çµ±ç’°å¢ƒ**ä¿¡æ¯ï¼ˆPythonç‰ˆæœ¬ã€ä½œæ¥­ç³»çµ±ç­‰ï¼‰

é€™æ¨£å¯ä»¥å¹«åŠ©æŠ€è¡“æ”¯æ´äººå“¡æ›´å¿«åœ°å®šä½å’Œè§£æ±ºå•é¡Œã€‚